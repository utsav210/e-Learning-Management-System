{% extends 'index.html' %}
{% block title %}Dashboard | eLMS {% endblock title %}
{% block profile %}
{% url 'profile' student.student_id %}
{% endblock %}
{% block user %}
{{student.name}}
{% endblock user %}
{% block allCourses %}
{% url 'courses' %}
{% endblock%}
{% block courses %}
{% url 'myCourses' %}
{% endblock %}
{% block content %}
<div>
   <!--navigation links-->
   <div class="container">
      {% if recent_absences and recent_absences > 0 %}
      <div class="alert alert-warning alert-dismissible fade show text-center" role="alert">
         <span class="fw-bold">You have {{ recent_absences }} recent absence{% if recent_absences > 1 %}s{% endif %} in the last 7 days.</span>
         <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
      {% endif %}
      <div class="container shadow-sm">
         <nav style="--bs-breadcrumb-divider: url(&#34;data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='8'%3E%3Cpath d='M2.5 0L1 1.5 3.5 4 1 6.5 2.5 8l4-4-4-4z' fill='currentColor'/%3E%3C/svg%3E&#34;);" aria-label="breadcrumb">
            <ol class="breadcrumb p-3">
               <li class="breadcrumb-item active" aria-current="page">My courses</li>
            </ol>
         </nav>
      </div>
      {% if courses %}
      <!-- Course container -->
      <div class="card_primary d-flex justify-content-center flex-wrap">
         {% for course in courses %}
         <!-- individual course starts -->
         <div class="cd card text-center my-4 mx-4 courseAnim" style="width: 30rem !important;">
            <div class="card-header text-light fw-bold">
               Dept. of {{ course.department }}
            </div>
            <div class="card-body">
               <h5 class="card-title fw-bold"> {{ course.department }}-{{ course.code }} : {{ course.name }}</h5>
               
               <a href="{% url 'course' course.code %}" class="btn btn-outline-dark px-5">Enter</a>
            </div>
            <div class="card-footer text-light fw-bold">
               {% if course.faculty %}
               Course Teacher : {{ course.faculty.name }}
               {% else %}
               Teacher not assigned yet
               {% endif %}
            </div>
         </div>
         <!-- individual course ends -->
         {% endfor %}
         <!-- Course container ends -->
      </div>
      {% else %}
      <div class="text-center fs-5 text-secondary">
         <p>You are not enrolled in any courses</p>
      </div>
      {% endif %}
   </div>
</div>

<!-- Email Popup Modal (shown on first login if email not set) -->
{% if show_email_popup %}
<div class="modal fade show" id="emailModal" tabindex="-1" aria-labelledby="emailModalLabel" aria-hidden="false" style="display: block; background-color: rgba(0,0,0,0.5);">
   <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
         <div class="modal-header bg-primary text-white">
            <h5 class="modal-title" id="emailModalLabel">
               <span class="material-symbols-outlined me-2">email</span>
               Add Your Email Address
            </h5>
         </div>
         <div class="modal-body">
            <p class="text-muted">Please provide your email address to enable password reset functionality and receive important notifications.</p>
            <form id="emailForm">
               {% csrf_token %}
               <div class="mb-3">
                  <label for="email" class="form-label">Email Address <span class="text-danger">*</span></label>
                  <input type="email" class="form-control" id="email" name="email" required placeholder="Enter your email address">
                  <div class="form-text">This email will be used for password recovery and notifications.</div>
               </div>
               <div id="emailError" class="alert alert-danger d-none" role="alert"></div>
               <div id="emailSuccess" class="alert alert-success d-none" role="alert"></div>
            </form>
         </div>
         <div class="modal-footer">
            <button type="button" class="btn btn-secondary" id="skipEmailBtn">Skip for now</button>
            <button type="button" class="btn btn-primary" id="saveEmailBtn">Save Email</button>
         </div>
      </div>
   </div>
</div>
{% endif %}
{% if show_email_popup %}
<script>

(function(){
  var modalEl = document.getElementById('emailModal');
  var bsModal = window.bootstrap ? bootstrap.Modal.getOrCreateInstance(modalEl) : null;
  if (bsModal) { bsModal.show(); }
  else if (window.$ && $('#emailModal').modal) { $('#emailModal').modal('show'); }

  function hideModal(){
    if (bsModal) bsModal.hide();
    else if (window.$ && $('#emailModal').modal) $('#emailModal').modal('hide');
    else { modalEl.classList.remove('show'); modalEl.style.display='none'; }
  }

  function postData(payload){
    var url = '{% url "saveEmail" %}';
    if (window.$ && $.ajax) {
      return $.ajax({ url: url, method: 'POST', data: payload });
    }
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
      body: new URLSearchParams(payload).toString()
    }).then(function(res){ return res.json(); });
  }

  var saveBtn = document.getElementById('saveEmailBtn');
  var skipBtn = document.getElementById('skipEmailBtn');
  var emailInput = document.getElementById('email');
  var errorDiv = document.getElementById('emailError');
  var successDiv = document.getElementById('emailSuccess');

  if (skipBtn) skipBtn.addEventListener('click', function(){ hideModal(); });

  if (saveBtn) saveBtn.addEventListener('click', function(){
    var email = (emailInput.value || '').trim();
    errorDiv.classList.add('d-none'); successDiv.classList.add('d-none');
    if (!email) { errorDiv.textContent = 'Please enter your email address.'; errorDiv.classList.remove('d-none'); return; }
    var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(email)) { errorDiv.textContent = 'Please enter a valid email address.'; errorDiv.classList.remove('d-none'); return; }

    postData({ csrfmiddlewaretoken: '{{ csrf_token }}', email: email })
      .then(function(response){
        if (response && response.success) {
          successDiv.textContent = response.message || 'Saved'; successDiv.classList.remove('d-none');
          setTimeout(function(){ hideModal(); location.reload(); }, 1500);
        } else {
          errorDiv.textContent = (response && response.message) || 'Unable to save.'; errorDiv.classList.remove('d-none');
        }
      })
      .catch(function(){ errorDiv.textContent = 'An error occurred. Please try again.'; errorDiv.classList.remove('d-none'); });
  });
})();

</script>
{% endif %}
{% endblock %}